# Zinコンパイラ - アーキテクチャ概要

## プロジェクト概要

ZinコンパイラはHaskellで実装された**マークアップ言語コンパイラ**です。独自のZin言語記法をHTMLに変換し、効率的で安全なWeb文書生成を実現します。

## アーキテクチャ全体図

```
Zinファイル
    ↓
字句解析 (Lexer)
    ↓
構文解析 (Parser) → エラーハンドリング
    ↓
意味解析 (Semantic)
    ↓
分岐: 仮想DOM経由 or 直接生成
    ↓               ↓
仮想DOM生成     直接コード生成
    ↓               ↓
レンダラー      HTML出力
    ↓
HTML出力
```

## モジュール構成

### 1. **Main.hs** - エントリーポイント
- コマンドライン引数処理
- ファイル入出力制御
- コンパイルパイプライン管理
- エラー報告

### 2. **AST.hs** - 抽象構文木
- Zin言語の構造定義
- ブロック要素（段落、見出し、リスト、テーブルなど）
- スタイル情報（太字、斜体、リンクなど）
- 型安全なデータ構造

### 3. **Lexer.hs** - 字句解析
- テキストからトークンへの変換
- インデント処理
- スタイルタグ解析（`bold[0:5]`など）
- コメント処理

### 4. **Parser.hs** - 構文解析
- トークンからASTへの変換
- 文法規則の実装
- エラー回復機能
- モナド的な解析制御

### 5. **Error.hs** - エラーハンドリング
- 一貫したエラー報告
- 詳細な位置情報
- 建設的な修正提案
- 型安全なエラー管理

### 6. **Semantic.hs** - 意味解析
- ASTの妥当性検証
- スタイル範囲チェック
- テーブル構造検証
- 論理的一貫性の確認

### 7. **VirtualDOM.hs** - 仮想DOM
- 現代的なWeb開発パラダイム
- 効率的な差分計算
- イベントハンドリング
- コンポーネント指向設計

### 8. **VirtualCodeGen.hs** - 仮想DOMコード生成
- ASTから仮想DOMへの変換
- 複雑なスタイル処理
- ネストした構造の処理
- 最適化機能

### 9. **CodeGen.hs** - 直接HTML生成
- ASTから直接HTMLへの変換
- 高速で軽量な処理
- シンプルな出力
- エラー耐性

### 10. **Renderer.hs** - 高度レンダリング
- 状態管理
- キャッシュ機能
- クライアントサイドサポート
- パフォーマンス最適化

## コンパイルフロー

### 1. 字句解析フェーズ
```haskell
Text → [Token]
```
- 入力テキストをトークンに分解
- インデント情報を保持
- スタイル記法を解析

### 2. 構文解析フェーズ
```haskell
[Token] → Either ParseError Document
```
- トークンからASTを構築
- 文法規則を適用
- エラー検出と報告

### 3. 意味解析フェーズ
```haskell
Document → Either ParseError Document
```
- 構造的妥当性を検証
- スタイル競合を検出
- 論理的一貫性をチェック

### 4. コード生成フェーズ
```haskell
Document → VDocument → Text  (仮想DOM経由)
Document → Text              (直接生成)
```
- 2つの生成パスを提供
- 用途に応じた最適化
- セキュアなHTML出力

## Zin言語の記法例

```zin
h1: メインタイトル

p bold[0:4]: これは段落のサンプルです。

ul:
  : 最初の項目
  : 2番目の項目

t: | 名前 | 年齢 | 職業 |
r: | 太郎 | 25 | エンジニア |
r: | 花子 | 30 | デザイナー |

cb javascript: 
console.log("Hello, World!");

q: これは引用文です。
```

## 技術的特徴

### 関数型プログラミング
- **不変性**: すべてのデータ構造が不変
- **純粋関数**: 副作用のない関数設計
- **型安全性**: コンパイル時エラー検出
- **モナド**: エラーハンドリングと状態管理

### モジュラー設計
- **責任分離**: 各モジュールが特定の責任を持つ
- **依存関係管理**: 明確な依存関係
- **拡張性**: 新機能の追加が容易
- **テスタビリティ**: 個別モジュールのテスト

### パフォーマンス
- **遅延評価**: 必要時のみ計算実行
- **効率的なテキスト処理**: `Data.Text`使用
- **メモリ効率**: 無駄なメモリ使用を回避
- **最適化**: 複数の最適化手法

### セキュリティ
- **自動エスケープ**: XSS攻撃の防止
- **型チェック**: 不正な操作の防止
- **入力検証**: 不正入力の早期検出
- **安全なHTML生成**: セキュアな出力

## 開発とデバッグ

### エラー報告
```
document.zin:3:5: error: Missing colon ':' after tag
  suggestion: Add ':' after the tag, e.g., 'p : text'
```

### 型安全性による利点
- コンパイル時にバグの多くを検出
- リファクタリングの安全性
- ドキュメントとしての型情報
- IDE支援の向上

## 将来の拡張可能性

### SPAサポート
- クライアントサイドレンダリング
- 動的コンテンツ更新
- ルーティング機能
- 状態管理

### プラグインシステム
- カスタムブロック要素
- 独自レンダラー
- 外部ツール連携
- テーマシステム

### 最適化機能
- コード最小化
- 画像最適化
- CDN統合
- ビルド最適化

このアーキテクチャにより、ZinコンパイラはシンプルなマークアップからWebアプリケーション開発まで対応できる強力で拡張可能なツールとなっています。